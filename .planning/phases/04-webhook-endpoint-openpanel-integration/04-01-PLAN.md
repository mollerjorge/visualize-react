---
phase: 04-webhook-endpoint-openpanel-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/api.v1.integrations.lemon-squeezy-webhook.$id.tsx
autonomous: true
user_setup:
  - service: lemon-squeezy
    why: "Webhook signature verification"
    env_vars:
      - name: LEMON_SQUEEZY_WEBHOOK_SECRET
        source: "Lemon Squeezy Dashboard -> Settings -> Webhooks -> Signing secret"
  - service: openpanel
    why: "Server-side event tracking"
    env_vars:
      - name: OPENPANEL_CLIENT_SECRET
        source: "OpenPanel Dashboard -> Settings -> Client Secret"

must_haves:
  truths:
    - "Lemon Squeezy webhooks POST to endpoint and receive 200"
    - "Invalid signatures rejected with 401"
    - "order_created events tracked in OpenPanel with user data"
    - "subscription_created events tracked as subscription_created_test"
  artifacts:
    - path: "app/routes/api.v1.integrations.lemon-squeezy-webhook.$id.tsx"
      provides: "Webhook handler with HMAC verification and OpenPanel forwarding"
      exports: ["action"]
      min_lines: 60
  key_links:
    - from: "api.v1.integrations.lemon-squeezy-webhook.$id.tsx"
      to: "crypto.createHmac"
      via: "HMAC-SHA256 signature verification"
      pattern: "crypto\\.createHmac.*sha256"
    - from: "api.v1.integrations.lemon-squeezy-webhook.$id.tsx"
      to: "api.openpanel.dev/track"
      via: "fetch POST with auth headers"
      pattern: "fetch.*openpanel\\.dev"
---

<objective>
Implement Lemon Squeezy webhook endpoint with HMAC signature verification and OpenPanel server-side tracking.

Purpose: Enable conversion tracking by capturing payment events (order_created, subscription_created) from Lemon Squeezy and forwarding to OpenPanel analytics.

Output: Single Remix resource route handling webhook POST requests securely.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

@app/root.tsx (OpenPanel client ID: c1eb2b83-2218-46cd-907b-ce5681c8ad76)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook route with HMAC signature verification</name>
  <files>app/routes/api.v1.integrations.lemon-squeezy-webhook.$id.tsx</files>
  <action>
Create Remix resource route (no default export = API only).

Export async `action` function for POST handling:
1. Extract raw body with `request.text()` - MUST be before any JSON parsing (signature breaks otherwise)
2. Get X-Signature header from request
3. Compute HMAC-SHA256: `crypto.createHmac('sha256', process.env.LEMON_SQUEEZY_WEBHOOK_SECRET).update(rawBody).digest('hex')`
4. Compare using `crypto.timingSafeEqual()` - NOT string equality (prevents timing attacks)
5. Return 401 Response if signature invalid

Env vars used: LEMON_SQUEEZY_WEBHOOK_SECRET

AVOID:
- Using request.json() before signature verification (breaks signature)
- Using === for signature comparison (timing attack vulnerable)
- Throwing errors for invalid sig (return Response with 401)
  </action>
  <verify>
`npm run typecheck` passes
File exists at app/routes/api.v1.integrations.lemon-squeezy-webhook.$id.tsx
File exports `action` function
Contains crypto.createHmac and crypto.timingSafeEqual
  </verify>
  <done>
POST requests with invalid X-Signature header return 401 status
POST requests with valid signature proceed to processing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OpenPanel server-side tracking for payment events</name>
  <files>app/routes/api.v1.integrations.lemon-squeezy-webhook.$id.tsx</files>
  <action>
After signature verification passes:

1. Parse JSON from raw body: `JSON.parse(rawBody)`
2. Filter event type from `meta.event_name`:
   - "order_created" -> track as "order_created"
   - "subscription_created" -> track as "subscription_created_test"
   - Other events -> return 200 (ignore silently)

3. Extract from `data.attributes`:
   - user_name
   - user_email
   - subtotal_usd

4. POST to OpenPanel server-side API:
```typescript
fetch('https://api.openpanel.dev/track', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'openpanel-client-id': process.env.OPENPANEL_CLIENT_ID!,
    'openpanel-client-secret': process.env.OPENPANEL_CLIENT_SECRET!,
  },
  body: JSON.stringify({
    type: 'track',
    payload: {
      name: eventName,
      properties: { user_name, user_email, subtotal_usd }
    }
  })
})
```

5. Return 200 even if OpenPanel call fails (prevents Lemon Squeezy retry storms)
6. Log OpenPanel errors with console.error for debugging

Env vars used: OPENPANEL_CLIENT_ID (existing: c1eb2b83-2218-46cd-907b-ce5681c8ad76), OPENPANEL_CLIENT_SECRET

AVOID:
- Returning non-200 when OpenPanel fails (causes retry loop)
- Blocking on OpenPanel response before returning (use fire-and-forget pattern if needed)
  </action>
  <verify>
`npm run typecheck` passes
File contains fetch to api.openpanel.dev/track
File checks meta.event_name for order_created and subscription_created
File extracts user_name, user_email, subtotal_usd from data.attributes
  </verify>
  <done>
order_created events send "order_created" to OpenPanel with user_name, user_email, subtotal_usd
subscription_created events send "subscription_created_test" to OpenPanel with same properties
Endpoint always returns 200 after valid signature
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` - no TypeScript errors
2. `npm run build` - production build succeeds
3. Grep verification:
   - `grep -q "createHmac" app/routes/api.v1.integrations.lemon-squeezy-webhook.\$id.tsx`
   - `grep -q "timingSafeEqual" app/routes/api.v1.integrations.lemon-squeezy-webhook.\$id.tsx`
   - `grep -q "openpanel.dev/track" app/routes/api.v1.integrations.lemon-squeezy-webhook.\$id.tsx`
</verification>

<success_criteria>
- [ ] Route file created at correct Remix path
- [ ] Exports action function (no default export = resource route)
- [ ] Uses request.text() for raw body before JSON parsing
- [ ] HMAC-SHA256 with timingSafeEqual for signature verification
- [ ] Returns 401 for invalid signatures
- [ ] Filters order_created and subscription_created events
- [ ] Sends events to OpenPanel with user_name, user_email, subtotal_usd
- [ ] Always returns 200 after valid signature (even if OpenPanel fails)
- [ ] npm run typecheck passes
- [ ] npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook-endpoint-openpanel-integration/04-01-SUMMARY.md`
</output>
