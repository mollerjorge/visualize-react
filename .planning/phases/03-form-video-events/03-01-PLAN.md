---
phase: 03-form-video-events
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/Modal.jsx
  - app/components/Hero.jsx
  - app/components/Bonus.jsx
autonomous: true

must_haves:
  truths:
    - "Exit-intent modal submission tracked with success/failure status"
    - "Hero video play events tracked with video ID and position"
    - "Bonus video play events tracked with video ID and position"
    - "Events visible in OpenPanel dashboard"
  artifacts:
    - path: "app/components/Modal.jsx"
      provides: "Form submission tracking"
      contains: "window.op('track', 'form_submitted'"
    - path: "app/components/Hero.jsx"
      provides: "Video play/pause/ended tracking"
      contains: "window.op('track', 'video_"
    - path: "app/components/Bonus.jsx"
      provides: "Video play/pause/ended tracking"
      contains: "window.op('track', 'video_"
  key_links:
    - from: "app/components/Modal.jsx"
      to: "window.op"
      via: "Tracking after fetch response"
      pattern: "if.*response\\.ok.*window\\.op"
    - from: "app/components/Hero.jsx"
      to: "window.op"
      via: "video event listeners"
      pattern: "addEventListener.*play"
    - from: "app/components/Bonus.jsx"
      to: "window.op"
      via: "video event listeners"
      pattern: "addEventListener.*play"
---

<objective>
Track form submissions and video engagement in OpenPanel

Purpose: Complete analytics parity - Phase 3 finishes the OpenPanel integration by capturing email capture conversion and video engagement metrics
Output: Modal.jsx tracks form success/failure, Hero.jsx and Bonus.jsx track video play/pause/ended with position data
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-form-video-events/03-RESEARCH.md

@app/components/Modal.jsx
@app/components/Hero.jsx
@app/components/Bonus.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add form submission tracking to Modal</name>
  <files>app/components/Modal.jsx</files>
  <action>
Add OpenPanel tracking to the form submission handler AFTER the fetch response:

1. In the `if (response.ok)` block (after line 97), add:
```javascript
if (typeof window !== 'undefined' && window.op) {
  window.op('track', 'form_submitted', {
    form_name: 'email_capture',
    form_type: 'exit_intent_modal',
    status: 'success'
  });
}
```

2. In the `else` block (around line 104), add:
```javascript
if (typeof window !== 'undefined' && window.op) {
  window.op('track', 'form_submitted', {
    form_name: 'email_capture',
    form_type: 'exit_intent_modal',
    status: 'error',
    error_code: response.status
  });
}
```

3. In the `catch (error)` block (around line 108), add:
```javascript
if (typeof window !== 'undefined' && window.op) {
  window.op('track', 'form_submitted', {
    form_name: 'email_capture',
    form_type: 'exit_intent_modal',
    status: 'error',
    error_type: 'network'
  });
}
```

Important: Track AFTER response, not on submit - prevents duplicates from validation errors.
Pattern matches existing defensive checks from Phase 2.
  </action>
  <verify>
grep -n "window.op('track', 'form_submitted'" app/components/Modal.jsx returns 3 matches (success, error code, network error)
  </verify>
  <done>Form submission tracked with success/failure status, visible in OpenPanel dashboard</done>
</task>

<task type="auto">
  <name>Task 2: Add video event tracking to Hero</name>
  <files>app/components/Hero.jsx</files>
  <action>
Add video event tracking using HTML5 play/pause/ended events with cleanup:

1. Add a new useEffect after the existing scroll useEffect (around line 64):

```javascript
React.useEffect(() => {
  const video = document.getElementById('hero-video');
  if (!video) return;

  const handlePlay = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_played', {
        video_id: 'hero-video',
        video_title: 'Course intro',
        location: 'hero'
      });
    }
  };

  const handlePause = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_paused', {
        video_id: 'hero-video',
        play_position: Math.round(video.currentTime),
        duration: Math.round(video.duration)
      });
    }
  };

  const handleEnded = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_completed', {
        video_id: 'hero-video',
        duration: Math.round(video.duration)
      });
    }
  };

  video.addEventListener('play', handlePlay);
  video.addEventListener('pause', handlePause);
  video.addEventListener('ended', handleEnded);

  return () => {
    video.removeEventListener('play', handlePlay);
    video.removeEventListener('pause', handlePause);
    video.removeEventListener('ended', handleEnded);
  };
}, []);
```

Important: Include null check `if (!video) return;` to prevent SSR errors.
Cleanup function removes all listeners to prevent memory leaks.
Track all three events: play, pause (with position), ended.
  </action>
  <verify>
grep -n "video_played\|video_paused\|video_completed" app/components/Hero.jsx returns 3 matches
grep -n "removeEventListener" app/components/Hero.jsx shows cleanup exists
  </verify>
  <done>Hero video play/pause/ended tracked with video ID and position data</done>
</task>

<task type="auto">
  <name>Task 3: Add video event tracking to Bonus</name>
  <files>app/components/Bonus.jsx</files>
  <action>
Add video event tracking using same pattern as Hero:

1. Add a new useEffect after the existing scroll useEffect (around line 30):

```javascript
React.useEffect(() => {
  const video = document.getElementById('bonus-video');
  if (!video) return;

  const handlePlay = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_played', {
        video_id: 'bonus-video',
        video_title: 'React Interview Questions',
        location: 'bonus'
      });
    }
  };

  const handlePause = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_paused', {
        video_id: 'bonus-video',
        play_position: Math.round(video.currentTime),
        duration: Math.round(video.duration)
      });
    }
  };

  const handleEnded = () => {
    if (typeof window !== 'undefined' && window.op) {
      window.op('track', 'video_completed', {
        video_id: 'bonus-video',
        duration: Math.round(video.duration)
      });
    }
  };

  video.addEventListener('play', handlePlay);
  video.addEventListener('pause', handlePause);
  video.addEventListener('ended', handleEnded);

  return () => {
    video.removeEventListener('play', handlePlay);
    video.removeEventListener('pause', handlePause);
    video.removeEventListener('ended', handleEnded);
  };
}, []);
```

Same pattern as Hero - null check, all three events, proper cleanup.
  </action>
  <verify>
grep -n "video_played\|video_paused\|video_completed" app/components/Bonus.jsx returns 3 matches
grep -n "removeEventListener" app/components/Bonus.jsx shows 4 matches (1 existing + 3 new)
  </verify>
  <done>Bonus video play/pause/ended tracked with video ID and position data</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes (no TypeScript errors)
2. `npm run build` succeeds (no build errors)
3. Deploy to production, verify in OpenPanel dashboard:
   - Submit exit-intent modal: form_submitted event with status: success
   - Play hero video: video_played event with video_id: hero-video
   - Pause hero video: video_paused event with play_position
   - Play bonus video: video_played event with video_id: bonus-video
</verification>

<success_criteria>
- 3 form_submitted tracking calls in Modal.jsx (success, error code, network)
- 3 video events tracked in Hero.jsx (play, pause, ended)
- 3 video events tracked in Bonus.jsx (play, pause, ended)
- All useEffects have cleanup functions (removeEventListener)
- Build passes without errors
- Events visible in OpenPanel dashboard with correct metadata
</success_criteria>

<output>
After completion, create `.planning/phases/03-form-video-events/03-01-SUMMARY.md`
</output>
